# Домашнее задание к занятию 2 «Работа с Playbook»

## Подготовка к выполнению

1. * Необязательно. Изучите, что такое [ClickHouse](https://www.youtube.com/watch?v=fjTNS2zkeBs) и [Vector](https://www.youtube.com/watch?v=CgEhyffisLY).
2. Создайте свой публичный репозиторий на GitHub с произвольным именем или используйте старый.
3. Скачайте [Playbook](./playbook/) из репозитория с домашним заданием и перенесите его в свой репозиторий.
4. Подготовьте хосты в соответствии с группами из предподготовленного playbook.

## Основная часть

1. Подготовьте свой inventory-файл `prod.yml`.
2. Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает [vector](https://vector.dev). Конфигурация vector должна деплоиться через template файл jinja2.
3. При создании tasks рекомендую использовать модули: `get_url`, `template`, `unarchive`, `file`.
4. Tasks должны: скачать дистрибутив нужной версии, выполнить распаковку в выбранную директорию, установить vector.

Ответ:
Поднял при помощи terraform инфарструктуру centos для clickhouse и ubuntu для vector 
В исходном плейбук поправил ссылку на дистрибутив и поправил версию clichhouse. 

Установил clickhouse

```sh
RUNNING HANDLER [Start clickhouse service] ******************************************************************************************************************
changed: [clickhouse-01]

TASK [Create database] **************************************************************************************************************************************
changed: [clickhouse-01]

PLAY RECAP **************************************************************************************************************************************************
clickhouse-01              : ok=5    changed=4  
```

Написал playbook для установки vector. Установил vector. 
Использую dpkg по инструкции здесь:

https://vector.dev/docs/setup/installation/package-managers/dpkg/

Сконифгурировал при помощи template jinja2 , подставил в шаблоне в endpoint для вектор адрес clichouse сервера 
Запустил vector

5. Запустите `ansible-lint site.yml` и исправьте ошибки, если они есть.

Ответ:
Исправил все

```sh
Passed: 0 failure(s), 0 warning(s) on 1 files. Last profile that met the validation criteria was 'production'.
```

6. Попробуйте запустить playbook на этом окружении с флагом `--check`.

Ответ:
Запустил увидел что не все таски проверелись , видимо должен был скачать в /tmp что то но не скачал 


7. Запустите playbook на `prod.yml` окружении с флагом `--diff`. Убедитесь, что изменения на системе произведены.

Ответ:
Запустил , показал вот такие изменения:

```sh
TASK [Remove downloaded .deb file] 

************************************************************************************************************************************************************************************************************************************************************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/tmp/vector_0.33.1-1_amd64.deb",
-    "state": "file"
+    "state": "absent"
 }

changed: [vector-01]
```

8. Повторно запустите playbook с флагом `--diff` и убедитесь, что playbook идемпотентен.

Ответ:

Чтобы был идемпотентен убрал задачу , хотя не совсем согласен с тем что она лишняя:

```sh
    - name: Remove downloaded .deb file
      ansible.builtin.file:
        path: "/tmp/vector_{{ vector_version }}-1_amd64.deb"
        state: absent    
```

9. Подготовьте README.md-файл по своему playbook. В нём должно быть описано: что делает playbook, какие у него есть параметры и теги. Пример качественной документации ansible playbook по [ссылке](https://github.com/opensearch-project/ansible-playbook).
Ответ: 

описал

10. Готовый playbook выложите в свой репозиторий, поставьте тег `08-ansible-02-playbook` на фиксирующий коммит, в ответ предоставьте ссылку на него.

Сделал 

